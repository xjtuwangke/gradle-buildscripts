ext {
    // 运行和打包的环境选择, 默认是开发环境
    // 获取 gradle 参数中 -Dprofile 的值: gradle -Denv=production clean build
    environment = System.getProperty("env", "development")
}

version = getGitVersion()

def getGitVersion() {
    return 'git describe --tags --dirty'.execute().text.trim() + '-' + 'git symbolic-ref --short -q HEAD'.execute().text.trim().replace('/', '-')
}

def getBuildTime(String time) {
    def date = new Date()
    def formattedDate = date.format(time)
    return formattedDate
}

def loadConfiguration() {
    println "==> Load configuration for ${environment}"
    def configFile = file('config.groovy') // 配置文件
    def conf = new ConfigSlurper(environment).parse(configFile.toURI().toURL()).toProperties()
    conf.setProperty("app.version", getGitVersion())
    conf.setProperty("app.buildTime", getBuildTime("yy-MM-dd HH:mm:ss"))
    return conf
}

processResources {
    // src/main/resources 下的文件中 @key@ 的内容使用 config.groovy 里对应的进行替换
    from(sourceSets.main.resources.srcDirs) {
        loadConfiguration().getProperties()
        filter(org.apache.tools.ant.filters.ReplaceTokens, tokens: loadConfiguration())
    }
}